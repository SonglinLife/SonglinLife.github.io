<!-- build time:Wed May 11 2022 20:03:18 GMT+0800 (China Standard Time) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Life" href="https://songlinlife.top/rss.xml"><link rel="alternate" type="application/atom+xml" title="Life" href="https://songlinlife.top/atom.xml"><link rel="alternate" type="application/json" title="Life" href="https://songlinlife.top/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="ANNS"><link rel="canonical" href="https://songlinlife.top/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/Efficient-and-robust-approximate-nearest-neighbor-search-using-Hierarchical-Navigable-Small-World-graphs/"><title>ANNS:HNSW算法详解 - 数据库 | Songlin = Life</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">ANNS:HNSW算法详解</h1><div class="meta"><span class="item" title="创建时间：2022-04-19 19:25:07"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-04-19T19:25:07+08:00">2022-04-19</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>2.9k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>3 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Songlin</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclj61ylzj20zk0m8b29.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclxp31goj20zk0m8qv5.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclgrvbd6j20zk0m8qv5.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicliierfjj20zk0m8npd.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giph47e9vtj20zk0m8x6l.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipeuibk9fj20zk0m8ay2.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="item" rel="index" title="分类于 数据库"><span itemprop="name">数据库</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://songlinlife.top/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/Efficient-and-robust-approximate-nearest-neighbor-search-using-Hierarchical-Navigable-Small-World-graphs/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Kalice"><meta itemprop="description" content=", Life is not about lifestyle, it means Lithium and Ferrum."></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Life"></span><div class="body md" itemprop="articleBody"><p>这算是我看的第一篇 ANNS 文章，感觉像是打开了新世界的大门，后续读了一些 ANNS 文章，感觉没有读这一篇那么心潮澎湃了。</p><h3 id="论文动机"><a class="anchor" href="#论文动机">#</a> 论文动机</h3><h4 id="作者希望解决的问题"><a class="anchor" href="#作者希望解决的问题">#</a> 作者希望解决的问题</h4><p>​	K 近邻检索（K-NNS）在很多场景有着很强的需求，naive 的思想就是扫一遍整个数据集，然后找到 KNN，但是这样做无疑是极大耗时间的。虽然后续有很多更好的 KNNS 算法提出，但是由于 <code>curse of dimensionality</code> 维度诅咒的存在 KNNS 只适用于低维度的数据。为了解决这一问题，KANNS 被提出，只是检索最近似的邻居。通过用召回率，即（检索得到的最近邻）/ K。</p><p>现有的很多算法，比如基于树的方法<a href="https://songlinlife.top/2022/%E6%A0%91%E6%9F%A5%E8%AF%A2%E7%AE%97%E6%B3%95/">树检索算法</a>，基于哈希的算法，基于 product quantization（PQ）的方法。但是基于临近图（proximity graph）的 ANNS 算法取得了更加出色的性能。</p><p>但是这些图算法有一些缺点：</p><p>1）查询步数呈现幂律分布。</p><p>2）有可能失去全局连通性，导致只在 cluster 进行查询。</p><h4 id="作者提出的解决办法"><a class="anchor" href="#作者提出的解决办法">#</a> 作者提出的解决办法</h4><p>作者根据 proximity graph 提出了 NSW。（NSW 我没有读）NSW 的核心就是通过贪心算法查询 p 节点的 M 个最近邻，然后把查到的 M 的最近邻作为 p 节点的邻居。</p><p>NSW 的查询复杂度是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><msup><mi>g</mi><mn>2</mn></msup><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">log^2(S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8141079999999999em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mclose">)</span></span></span></span>，因为平均查询步数为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">log(S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mclose">)</span></span></span></span>，而平均度数也为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">log(S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mclose">)</span></span></span></span>。这就导致总的 distance 计算次数为平方。</p><p>而 HNSW 为了降低这个查询复杂度，提出了多层 graph 模型。</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220423215759395.png" alt="image-20220423215759395"></p><h3 id="hnsw算法拆解"><a class="anchor" href="#hnsw算法拆解">#</a> HNSW 算法拆解</h3><p>作者关于 HNSW 的介绍，HNSW 的结构实际上类似于跳表：</p><blockquote><p>The Hierarchical NSW idea is also very similar to a well-known 1D probabilistic skip list structure [27] and can be described using its terms.</p></blockquote><h4 id="邻居选择策略"><a class="anchor" href="#邻居选择策略">#</a> 邻居选择策略</h4><p>HNSW 其实是一个 DG+RNG 图。</p><p>DG 图就是下面这个每个三角形之内，不能有其他点，DG 图可以给 ANNS 提供很好的查询精度，但是对于高纬度数据，DG 图会退化为全连接，可以看这篇文章 <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMzM1MjY2MzI=">DG 图</span>：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220423222945245.png" alt="image-20220423222945245"></p><p>RNG 图就是下面这个月牙里面不能有其他节点，if 𝑥 and 𝑦 are connected by edge 𝑒 ∈ 𝐸, then ∀𝑧 ∈ 𝑉 , with 𝛿 (𝑥, 𝑦) &lt; 𝛿 (𝑥, 𝑧), or 𝛿 (𝑥, 𝑦) &lt; 𝛿 (𝑧, 𝑦)，这个 RNG 图我一开始很难理解，其实这个月牙是两个圆相交，那么这个月牙内每个节点到 x 或者 y 的距离一定是都要小于 x,y 的距离的。可以画个图，以 x 圆形以 xy 为半径和以 y 为圆形 xy 为半径进行画图相交得到月牙，那么这里面的所有节点到 x 和 y 的距离都小于 xy。</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220423223514215.png" alt="image-20220423223514215"></p><p>HNSW 借鉴了 RNG 的这种思想，也就是启发式选边，但是并没有构建一个真的 RNG 图，因为一个 RNG 的构建复杂度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi mathvariant="normal">∣</mi><mi>S</mi><msup><mi mathvariant="normal">∣</mi><mn>3</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(|S|^3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.02778em">O</span><span class="mopen">(</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8141079999999999em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p><p>RNG 论文中对 RNG 图的定义：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424105155163.png" alt="image-20220424105155163"></p><p>其实就是指的月牙里面没有点。</p><p>so，首先我们 look one down 选边策略：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220423224657961.png" alt="image-20220423224657961"></p><p>extendCandidates 是一个数据加强的策略，把 Candidate 的 neighbour 也加入到 Candidate 中，因为 KGraph 也提到过，<em>邻居的邻居很有可能是邻居</em>。</p><p>我们主要看这个核心的启发式选边策略：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220423225152676.png" alt="image-20220423225152676"></p><p><code>extract nearest element from W to q</code> ，也就是说这个循环是 distance 从小到大开始选边。这里的类 RNG 是，我们需要满足没有连接的边出现在上图说的月牙形状中，而不是说没有点出现在月牙中，这有点难理解。这个选边策略其实和 NSG 的选边策略相同。。。</p><p>RNG 图的要求，如果 x,y 要进行连接，那么不能出现一个节点到 x 或者 y 的距离都小于 x,y 的距离。而我们从小到大开始选边，那么默认满足了之前选择的节点到 q 的距离一定小于现在这个节点 e 到 q 的距离。那么如果出现之前选择的节点到 e 的距离小于 q 和 e 之间的距离，那么我们就触发了 RNG 的丢弃条件了。HNSW 叫启发式选边，而 NSG 叫 MRNG，难绷。。。</p><p><strong>易远丁真，鉴定为最近邻。</strong></p><p>这种启发式选边的最大好处就是继承了类似 RNG 的属性，就是是稀疏性。</p><p>作者说这样可以连接到不同的 cluster，其实这正是 RNG 的特性之一，RNG 的特定就是强连通性。因为如果节点出现聚集，那么两个 cluster 的边界节点很可能是稀疏的，也就是月牙状里面没有其他节点，那么我们就能够把他们进行连接。</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220423232313593.png" alt="image-20220423232313593"></p><h4 id="layer搜索算法"><a class="anchor" href="#layer搜索算法">#</a> layer 搜索算法</h4><p>首先是层检索算法，因为 HNSW 是一个分层的结构，所以我们检索时候实际上是从上到下进行检索，每一层都进行检索。</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220423233156710.png" alt="image-20220423233156710"></p><p>其实这就是一个贪心算法，换汤不换药。给定一个 Candidate list 和 result list，每一次迭代取出 Candidate 中和 q 最近的点 c，如果这个最近的点比 result 中离 q 最远的点 f 还要远，说明达到了局部最佳，这时候 break。如果还可以优化就继续检索 c 的邻居节点。</p><p>注意，贪心算法是非回溯的。在 NSG 中证明了 MRNG 是一个 MSNET，通过贪心非回溯算法得到的结果，它的搜索路径一定是单调路径。</p><h4 id="插入算法"><a class="anchor" href="#插入算法">#</a> 插入算法</h4><p>因为 HNSW 的多层结构，我们在插入的时候也是从上到下进行插入。</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424104002378.png" alt="image-20220424104002378"></p><p>这个算法我觉得没有太多需要注意的地方。需要注意的就是，在选择 neighbour 之后需要加上双向边，这就导致了可能出现节点的度大于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">M_{max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.10903em">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:-.10903em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。因此需要进行 shrink 操作。</p><p>插入法归纳步骤。1）随机 roll 一个层数 l，从当前图的 top level L 开始查询，每次就去最近邻，直到查到 l 层。2）使用贪心算法检索出候选邻居，并使用启发式算法对候选邻居进行选择，给这些邻居添加 <strong>双向边</strong>。3）如果邻居的度超过了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">M_{max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.10903em">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:-.10903em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，那么对邻居执行一次查询选择操作，并为候选邻居添加 <strong>单向边</strong>。</p><h4 id="总的查询算法"><a class="anchor" href="#总的查询算法">#</a> 总的查询算法</h4><p>第 0 层以上的，使用 ef=1，第 0 层使用用户指定的 ef。层次化查询，easy。</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424104910397.png" alt="image-20220424104910397"></p><h3 id="问题"><a class="anchor" href="#问题">#</a> 问题</h3><p>如果设置固定层数，随机因子固定，对性能影响？</p><p>为什么通过启发式构建的图，能够使用贪婪算法？以及证明贪婪算法收敛？</p><h3 id="构建参数影响"><a class="anchor" href="#构建参数影响">#</a> 构建参数影响</h3><p>构建索引这里面有很多参数，比如 $M_{max0} \quad efConstruction \quad m_L\quad M $.</p><p>一般 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>L</mi></msub></mrow><annotation encoding="application/x-tex">m_L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 选择为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mi>ln</mi><mo>⁡</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">1/\ln{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mord">/</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.10903em">M</span></span></span></span></span> 。</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424112057862.png" alt="image-20220424112057862"></p><p>作者也对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi><mn>0</mn></mrow></msub></mrow><annotation encoding="application/x-tex">M_{max0}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.10903em">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.10903em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 进行了研究，发现取 2M 时候效果最好</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424114751408.png" alt="image-20220424114751408"></p><p>efconstruction 可以通过 simple data 来自动 configured。</p><p>唯一对用户有意义的参数就是 M，也就是节点的度，作者也对 M 的取值做了实验，12 或者 20 是一个比较好的选择，anns-benchmark 也是取 12 和 20：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424115031521.png" alt="image-20220424115031521"></p><h4 id="性能评估"><a class="anchor" href="#性能评估">#</a> 性能评估</h4><p>作者从四个方面对算法是性能进行评估：</p><h4 id="和baseline-nsw进行比较"><a class="anchor" href="#和baseline-nsw进行比较">#</a> 和 baseline NSW 进行比较</h4><p>使用维度为 4 的随机数据，可以看到 HNSW 吊打 NSW。</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424115715624.png" alt="image-20220424115715624"></p><h4 id="欧式空间内进行比较"><a class="anchor" href="#欧式空间内进行比较">#</a> 欧式空间内进行比较</h4><p>用到的对比算法：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424115905927.png" alt="image-20220424115905927"></p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424115915647.png" alt="image-20220424115915647"></p><p>用到的数据集：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424115930890.png" alt="image-20220424115930890"></p><p>结果：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424120053747.png" alt="image-20220424120053747"></p><p>低纬度的随机数据，HNSW 略微好于 annoy，其他情况下都是吊打。</p><h4 id="非欧空间"><a class="anchor" href="#非欧空间">#</a> 非欧空间</h4><p>这个不是很懂，以后再看吧</p><h4 id="和pq方法的对比"><a class="anchor" href="#和pq方法的对比">#</a> 和 pq 方法的对比</h4><p>参数设置：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424120413221.png" alt="image-20220424120413221"></p><p>结果：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220424120444921.png" alt="image-20220424120444921"></p><p>依旧是吊打，但是图方法的最大劣势就是耗内存很多。。。</p><div class="tags"><a href="/tags/ANNS/" rel="tag"><i class="ic i-tag"></i> ANNS</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-05-11 19:42:45" itemprop="dateModified" datetime="2022-05-11T19:42:45+08:00">2022-05-11</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Kalice 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Kalice 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Kalice <i class="ic i-at"><em>@</em></i>Life</li><li class="link"><strong>本文链接：</strong> <a href="https://songlinlife.top/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/Efficient-and-robust-approximate-nearest-neighbor-search-using-Hierarchical-Navigable-Small-World-graphs/" title="ANNS:HNSW算法详解">https://songlinlife.top/2022/数据库/Efficient-and-robust-approximate-nearest-neighbor-search-using-Hierarchical-Navigable-Small-World-graphs/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%EF%BC%9ADiskANN-Fast-Accurate-Billion-point-Nearest-Neighbor-Search-on-a-Single-Node/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giph4fomxoj20zk0m8axp.jpg" title="论文阅读：DiskANN: Fast Accurate Billion-point Nearest Neighbor Search on a Single Node"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 数据库</span><h3>论文阅读：DiskANN: Fast Accurate Billion-point Nearest Neighbor Search on a Single Node</h3></a></div><div class="item right"><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%EF%BC%9ANSG/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclg5ms2rj20zk0m8u0x.jpg" title="论文阅读：NSG"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 数据库</span><h3>论文阅读：NSG</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BA%E6%96%87%E5%8A%A8%E6%9C%BA"><span class="toc-number">1.</span> <span class="toc-text">论文动机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E8%80%85%E5%B8%8C%E6%9C%9B%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">作者希望解决的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E8%80%85%E6%8F%90%E5%87%BA%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">作者提出的解决办法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hnsw%E7%AE%97%E6%B3%95%E6%8B%86%E8%A7%A3"><span class="toc-number">2.</span> <span class="toc-text">HNSW 算法拆解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%82%BB%E5%B1%85%E9%80%89%E6%8B%A9%E7%AD%96%E7%95%A5"><span class="toc-number">2.1.</span> <span class="toc-text">邻居选择策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#layer%E6%90%9C%E7%B4%A2%E7%AE%97%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">layer 搜索算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E7%AE%97%E6%B3%95"><span class="toc-number">2.3.</span> <span class="toc-text">插入算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%9A%84%E6%9F%A5%E8%AF%A2%E7%AE%97%E6%B3%95"><span class="toc-number">2.4.</span> <span class="toc-text">总的查询算法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%8F%82%E6%95%B0%E5%BD%B1%E5%93%8D"><span class="toc-number">4.</span> <span class="toc-text">构建参数影响</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E8%AF%84%E4%BC%B0"><span class="toc-number">4.1.</span> <span class="toc-text">性能评估</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%92%8Cbaseline-nsw%E8%BF%9B%E8%A1%8C%E6%AF%94%E8%BE%83"><span class="toc-number">4.2.</span> <span class="toc-text">和 baseline NSW 进行比较</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AC%A7%E5%BC%8F%E7%A9%BA%E9%97%B4%E5%86%85%E8%BF%9B%E8%A1%8C%E6%AF%94%E8%BE%83"><span class="toc-number">4.3.</span> <span class="toc-text">欧式空间内进行比较</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E6%AC%A7%E7%A9%BA%E9%97%B4"><span class="toc-number">4.4.</span> <span class="toc-text">非欧空间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%92%8Cpq%E6%96%B9%E6%B3%95%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="toc-number">4.5.</span> <span class="toc-text">和 pq 方法的对比</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/CMU445%EF%BC%9A%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/" rel="bookmark" title="CMU445：存储引擎">CMU445：存储引擎</a></li><li><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%EF%BC%9AA-Comprehensive-Survey-and-Experimental-Comparison-of-Graph-Based-Approximate-Nearest-Neighbor-Search/" rel="bookmark" title="论文阅读：A Comprehensive Survey and Experimental Comparison of Graph-Based Approximate Nearest Neighbor Search">论文阅读：A Comprehensive Survey and Experimental Comparison of Graph-Based Approximate Nearest Neighbor Search</a></li><li><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%EF%BC%9ADiskANN-Fast-Accurate-Billion-point-Nearest-Neighbor-Search-on-a-Single-Node/" rel="bookmark" title="论文阅读：DiskANN: Fast Accurate Billion-point Nearest Neighbor Search on a Single Node">论文阅读：DiskANN: Fast Accurate Billion-point Nearest Neighbor Search on a Single Node</a></li><li class="active"><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/Efficient-and-robust-approximate-nearest-neighbor-search-using-Hierarchical-Navigable-Small-World-graphs/" rel="bookmark" title="ANNS:HNSW算法详解">ANNS:HNSW算法详解</a></li><li><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%EF%BC%9ANSG/" rel="bookmark" title="论文阅读：NSG">论文阅读：NSG</a></li><li><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%EF%BC%9AFANNG/" rel="bookmark" title="论文阅读：FANNG">论文阅读：FANNG</a></li><li><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%A0%91%E6%9F%A5%E8%AF%A2%E7%AE%97%E6%B3%95/" rel="bookmark" title="最近邻检索树算法——KD树，Ball树,VP树">最近邻检索树算法——KD树，Ball树,VP树</a></li><li><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/KGraph/" rel="bookmark" title="ANNS：KGraph">ANNS：KGraph</a></li><li><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/DiskANN%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E5%BC%80%E5%A7%8B/" rel="bookmark" title="DiskANN（一）：代码阅读开始">DiskANN（一）：代码阅读开始</a></li><li><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/ANNS-EFANN%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" rel="bookmark" title="ANNS: EFANNA论文阅读">ANNS: EFANNA论文阅读</a></li><li><a href="/2022/NSG-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" rel="bookmark" title="NSG 源码阅读">NSG 源码阅读</a></li><li><a href="/2022/ANNS-HM-ANN%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" rel="bookmark" title="ANNS: HM-ANN论文阅读">ANNS: HM-ANN论文阅读</a></li><li><a href="/2022/ANNS%E5%B8%B8%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E9%9B%86/" rel="bookmark" title="ANNS常用的数据集">ANNS常用的数据集</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Kalice" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Kalice</p><div class="description" itemprop="description">Life is not about lifestyle, it means Lithium and Ferrum.</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">110</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">20</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">42</span> <span class="name">标签</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%EF%BC%9ADiskANN-Fast-Accurate-Billion-point-Nearest-Neighbor-Search-on-a-Single-Node/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%EF%BC%9ANSG/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/linux/" title="分类于 linux">linux</a></div><span><a href="/2022/linux/MIT6-s081%EF%BC%9Alab2/" title="MIT6.s081：lab2">MIT6.s081：lab2</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ai/" title="分类于 AI">AI</a></div><span><a href="/2021/ai/PageRank/" title="PageRank算法">PageRank算法</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ss/" title="分类于 琐事">琐事</a></div><span><a href="/2022/ss/HTML%EF%BC%9A%E5%AD%A6%E4%B9%A0/" title="HTML与CSS学习">HTML与CSS学习</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" title="分类于 分布式">分布式</a></div><span><a href="/2022/%E5%88%86%E5%B8%83%E5%BC%8F/MIT6-824-Lab4/" title="MIT6.824:Lab4">MIT6.824:Lab4</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Vim/" title="分类于 Vim">Vim</a></div><span><a href="/2022/vim/Vscode%20+%20Vim/" title="Vscode+vim">Vscode+vim</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/xlab/" title="分类于 xlab">xlab</a></div><span><a href="/2022/xlab/GrimoireLab%EF%BC%9A%E5%A1%AB%E5%9D%91%E8%AE%B0/" title="GrimoireLab：填坑记">GrimoireLab：填坑记</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" title="分类于 数据库">数据库</a></div><span><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/CMU445%EF%BC%9A%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/" title="CMU445：存储引擎">CMU445：存储引擎</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Go/" title="分类于 Go">Go</a></div><span><a href="/2022/Go/Golang%EF%BC%9A%E6%9F%A5%E8%AF%A2MongoDB/" title="Golang：查询MongoDB">Golang：查询MongoDB</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" title="分类于 数据库">数据库</a></div><span><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/ANNS-EFANN%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" title="ANNS: EFANNA论文阅读">ANNS: EFANNA论文阅读</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/docker/" title="分类于 容器">容器</a></div><span><a href="/2022/docker/docker02-Run%E5%91%BD%E4%BB%A4/" title="docker02: Run命令">docker02: Run命令</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Kalice @ Songlin</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">224k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">3:24</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/数据库/Efficient-and-robust-approximate-nearest-neighbor-search-using-Hierarchical-Navigable-Small-World-graphs/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,copy_tex:!0,katex:!0,mermaid:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->