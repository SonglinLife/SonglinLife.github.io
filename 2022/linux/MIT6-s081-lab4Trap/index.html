<!-- build time:Wed May 11 2022 19:59:38 GMT+0800 (China Standard Time) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Life" href="https://songlinlife.top/rss.xml"><link rel="alternate" type="application/atom+xml" title="Life" href="https://songlinlife.top/atom.xml"><link rel="alternate" type="application/json" title="Life" href="https://songlinlife.top/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="MIT"><link rel="canonical" href="https://songlinlife.top/2022/linux/MIT6-s081-lab4Trap/"><title>MIT6.s081: lab4Trap - linux | Songlin = Life</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">MIT6.s081: lab4Trap</h1><div class="meta"><span class="item" title="创建时间：2022-04-25 20:42:38"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-04-25T20:42:38+08:00">2022-04-25</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>4.3k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>4 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Songlin</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicljitigmj20zk0m87fp.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclfw2t96j20zk0m8x6p.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclxxcb6rj20zk0m8b29.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipeybxm1pj20zk0m8niv.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicitspjpbj20zk0m81ky.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclh3brzpj20zk0m8ann.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/linux/" itemprop="item" rel="index" title="分类于 linux"><span itemprop="name">linux</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://songlinlife.top/2022/linux/MIT6-s081-lab4Trap/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Kalice"><meta itemprop="description" content=", Life is not about lifestyle, it means Lithium and Ferrum."></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Life"></span><div class="body md" itemprop="articleBody"><h3 id="risc-v-assembly"><a class="anchor" href="#risc-v-assembly">#</a> RISC-V assembly</h3><p>首先是 call.c:</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/param.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/types.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/stat.h"</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user/user.h"</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">return</span> x<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">int</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %d\n"</span><span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后是 call 的汇编：</p><pre><code class="language-assembly">int g(int x) &#123;
   0:	1141                	addi	sp,sp,-16
   2:	e422                	sd	s0,8(sp)
   4:	0800                	addi	s0,sp,16
  return x+3;
&#125;
   6:	250d                	addiw	a0,a0,3
   8:	6422                	ld	s0,8(sp)
   a:	0141                	addi	sp,sp,16
   c:	8082                	ret

000000000000000e &lt;f&gt;:

int f(int x) &#123;
   e:	1141                	addi	sp,sp,-16
  10:	e422                	sd	s0,8(sp)
  12:	0800                	addi	s0,sp,16
  return g(x);
&#125;
  14:	250d                	addiw	a0,a0,3
  16:	6422                	ld	s0,8(sp)
  18:	0141                	addi	sp,sp,16
  1a:	8082                	ret

000000000000001c &lt;main&gt;:

void main(void) &#123;
  1c:	1141                	addi	sp,sp,-16
  1e:	e406                	sd	ra,8(sp)
  20:	e022                	sd	s0,0(sp)
  22:	0800                	addi	s0,sp,16
  printf(&quot;%d %d\n&quot;, f(8)+1, 13);
  24:	4635                	li	a2,13
  26:	45b1                	li	a1,12
  28:	00000517          	auipc	a0,0x0
  2c:	7a050513          	addi	a0,a0,1952 # 7c8 &lt;malloc+0xe8&gt;
  30:	00000097          	auipc	ra,0x0
  34:	5f8080e7          	jalr	1528(ra) # 628 &lt;printf&gt;
  exit(0);
  38:	4501                	li	a0,0
  3a:	00000097          	auipc	ra,0x0
  3e:	274080e7          	jalr	628(ra) # 2ae &lt;exit&gt;

</code></pre><p>我主要说一下各个指令的作用 auipc 将当前 pc 值 load 到特定的寄存器中。比如</p><pre><code class="language-assembly">30:	00000097          	auipc	ra,0x0
34:	5f8080e7          	jalr	1528(ra) # 628 &lt;printf&gt;
</code></pre><p>把当前 pc 的值加上 0x0 也就是 30 放到 ra 中，因为 ra 就是 return address， <code>jalr</code> 会将 pc+4 存储给指定的寄存器，反汇编语句里省略了指定寄存器，是因为默认给 ra，所以 ra= <code>0x38</code> 。</p><p><code>1528(ra)</code> 表示 ra 中的值加上 1528 生成一个地址，然后去这个地址寻找到数据作为指令进行解释并执行也就是跳转操作。printf 执行完毕后就会执行 <code>ret</code> 指令，ret 指令就去 <code>ra</code> 中把 <code>return address</code> 找到并且并且读取开始执行。</p><p>有意思的是这个：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0x00646c72</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"H%x Wo%s"</span><span class="token punctuation">,</span> <span class="token number">57616</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这个会打印 <code>He110 World</code> 。这里官方给出的代码没有进行指针强转，会没法编译。riscv 存数据的方式就是小端存储也就是正常的人类顺序。 <code>64</code> 对应 <code>o</code> ， <code>89</code> 对应。。。跑题了，反正就是一一进行解释，最后显示 <code>Hello world</code> 。</p><p>In the following code, what is going to be printed after <code>'y='</code> ? (note: the answer is not a specific value.) Why does this happen?</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"x=%d y=%d"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>因为 printf 需要三个参数，所以给 y 复制的寄存器就是 <code>a2</code> 。</p><h3 id="gdb常用指令"><a class="anchor" href="#gdb常用指令">#</a> gdb 常用指令</h3><h4 id="开启调试"><a class="anchor" href="#开启调试">#</a> 开启调试</h4><pre><code class="language-sh">make qemu-gdb CPU=1 # 限制cpu个数
risriscv64-unknown-elf-gdb # 使用riscv gdb
</code></pre><h4 id="gdb命令"><a class="anchor" href="#gdb命令">#</a> gdb 命令</h4><p><code>Ctrl-c</code></p><p>Halt the machine and break in to GDB at the current instruction. If QEMU has multiple virtual CPUs, this halts all of them.</p><p><code>c (or continue)</code></p><p>Continue execution until the next breakpoint or <code>Ctrl-c</code> .</p><p><code>si (or stepi)</code></p><p>Execute one machine instruction.</p><p><code>b function or b file:line (or breakpoint)</code></p><p>Set a breakpoint at the given function or line.</p><p><code>b **addr* (or breakpoint)</code></p><p>Set a breakpoint at the EIP <em>addr</em>.</p><p><code>set print pretty</code></p><p>Enable pretty-printing of arrays and structs.</p><p><code>info registers</code></p><p>Print the general purpose registers, <code>eip</code> , <code>eflags</code> , and the segment selectors. For a much more thorough dump of the machine register state, see QEMU's own <code>info registers</code> command.</p><p><code>x/*N*x *addr*</code></p><p>Display a hex dump of <em>N</em> words starting at virtual address <em>addr</em>. If <em>N</em> is omitted, it defaults to 1. <em>addr</em> can be any expression.</p><p><code>x/*N*i *addr*</code></p><p>Display the <em>N</em> assembly instructions starting at <em>addr</em>. Using <code>$eip</code> as <em>addr</em> will display the instructions at the current instruction pointer.</p><p><code>symbol-file *file*</code></p><p>(Lab 3+) Switch to symbol file <em>file</em>. When GDB attaches to QEMU, it has no notion of the process boundaries within the virtual machine, so we have to tell it which symbols to use. By default, we configure GDB to use the kernel symbol file, <code>obj/kern/kernel</code> . If the machine is running user code, say <code>hello.c</code> , you can switch to the hello symbol file using <code>symbol-file obj/user/hello</code> .</p><p>关于 <code>x</code> 模式，这里有个简单列表：</p><pre><code>n:是正整数，表示需要显示的内存单元的个数，即从当前地址向后显示n个内存单元的内容，
一个内存单元的大小由第三个参数u定义。

f:表示addr指向的内存内容的输出格式，s对应输出字符串，此处需特别注意输出整型数据的格式：
  x 按十六进制格式显示变量.
  d 按十进制格式显示变量。
  u 按十进制格式显示无符号整型。
  o 按八进制格式显示变量。
  t 按二进制格式显示变量。
  a 按十六进制格式显示变量。
  c 按字符格式显示变量。
  f 按浮点数格式显示变量。
  i 按照指令方式进行打印。

u:就是指以多少个字节作为一个内存单元-unit,默认为4。u还可以用被一些字符表示:
  如b=1 byte, h=2 bytes,w=4 bytes,g=8 bytes.

&lt;addr&gt;:表示内存地址。
</code></pre><h4 id="qemu命令"><a class="anchor" href="#qemu命令">#</a> qemu 命令</h4><p><code>Ctrl+a x</code> 退出</p><p><code>Ctrl+a c</code> 进入 consle 模式，可以用 <code>info mem</code> 进行页表打印。</p><h3 id="trap"><a class="anchor" href="#trap">#</a> Trap</h3><h4 id="trap代码执行流程"><a class="anchor" href="#trap代码执行流程">#</a> Trap 代码执行流程</h4><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220426095322352.png" alt="image-20220426095322352"></p><h4 id="trap进入"><a class="anchor" href="#trap进入">#</a> trap 进入</h4><p>让我们再来回顾这张图</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220426095540263.png" alt="image-20220426095540263"></p><p>我们的目的就是通过 ecall 跳转到内核态，而核心的就是 trampoline 和 trapframe 两个页。trampoline page 中存放了处理在用户态处理 trap 的代码，并且这个 map 是系统为所有进程完成的，包括内核页表。</p><p>打开 qemu 之后，可以用 <code>info mem</code> 查看页表：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220426100039263.png" alt="image-20220426100039263"></p><p>可能这里把三级页表拆开了，反正可以看到 vaddr 中最下面两个最大的地址就是 trampoline page 和 trapframe page。</p><h5 id="ecall做的事情"><a class="anchor" href="#ecall做的事情">#</a> ecall 做的事情</h5><p>第一，ecall 将代码从 user mode 改到 supervisor mode。因为无论是 trampoline 还是 trapframe 都不能在用户态访问，因为标志位没有 <code>u</code> 。</p><p>第二，ecall 将程序计数器的值保存在了 SEPC 寄存器中。因为这是 trap 返回地址。</p><p>第三，ecall 把 stvec 寄存器中地址 load 到 pc 中。（stvec 就是中断向量地址，也就是 trampoline page 地址，因为 trampoline 就是用于存放处理 trap 的指令）</p><h5 id="保存寄存器状态"><a class="anchor" href="#保存寄存器状态">#</a> 保存寄存器状态</h5><p>使用 <code>csrrw a0 sscratch</code> 命令把 <code>a0</code> 和 <code>sscratch</code> 两个寄存器的值进行交换。sscratch 中保存的实际上就是 trapframe page 的地址，然后我们使用 save 指令把寄存器的值进行保存（这里截了一部分图，实际上上面还有很多保存寄存器的指令）：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220426101940437.png" alt="image-20220426101940437"></p><h5 id="加载处理内核数据"><a class="anchor" href="#加载处理内核数据">#</a> 加载处理内核数据</h5><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220426103708995.png" alt="image-20220426103708995"></p><p>这四条 load 指令，分别 load 了内核栈的栈顶指针、当前运行的 cpuid、处理终端的 usertrap () 函数的地址、kernel pagetable 的 id。</p><p>执行上面指令后，再次调用 <code>info mem</code> 可以看到：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220426103942318.png" alt="image-20220426103942318"></p><p>我们成功进入了内核！</p><h4 id="处理系统调用"><a class="anchor" href="#处理系统调用">#</a> 处理系统调用</h4><p><code>trap.c</code> 会保存当前的 <code>sepc</code> ，检查状态判断是否 <code>scause</code> 也就是 trap 原因。如果 <code>scause</code> 为 8，那就执行 <code>syscall()</code> ，syscall 会调用根据 <code>a7</code> 来判断导致执行那种系统调用，并把执行结果放在 <code>a0</code> 。</p><h4 id="trap返回"><a class="anchor" href="#trap返回">#</a> trap 返回</h4><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220426110357638.png" alt="image-20220426110357638"></p><p>内核发现这个进程并没有被杀死，于是它执行 trap 返回，也就是 usertrapret ()。</p><p>进入这个函数内：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220426110914010.png" alt="image-20220426110914010"></p><p>这部分其实做了很多事情，但是都是一些镜像的事情，也就是 trap 进入需要什么，这里就保存什么。</p><p>我们一路快进：</p><p><img data-src="https://image-2021-wu.oss-cn-beijing.aliyuncs.com/blogs/picturesimage-20220426111215836.png" alt="image-20220426111215836"></p><p>boom！又回到了 trampoline！</p><p>最后把之前保存的数据重新 load 进去，ok，整个系统调用完成！</p><h3 id="参考资料"><a class="anchor" href="#参考资料">#</a> 参考资料：</h3><p><span class="exturl" data-url="aHR0cDovL3h5Zmphc29uLnRvcC8yMDIxLzExLzMwL3h2Ni1taXQtNi1TMDgxLTIwMjAtTGFiNC10cmFwcy8=">http://xyfjason.top/2021/11/30/xv6-mit-6-S081-2020-Lab4-traps/</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cueXNibG9nLmNjL2FyY2hpdmVzL21pdDZzMDgxbGFiNA==">https://www.ysblog.cc/archives/mit6s081lab4</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9wZG9zLmNzYWlsLm1pdC5lZHUvNi44MjgvMjAxMi9sYWJndWlkZS5odG1s">lab tools</span></p><div class="tags"><a href="/tags/MIT/" rel="tag"><i class="ic i-tag"></i> MIT</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-05-11 19:42:45" itemprop="dateModified" datetime="2022-05-11T19:42:45+08:00">2022-05-11</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Kalice 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Kalice 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Kalice <i class="ic i-at"><em>@</em></i>Life</li><li class="link"><strong>本文链接：</strong> <a href="https://songlinlife.top/2022/linux/MIT6-s081-lab4Trap/" title="MIT6.s081: lab4Trap">https://songlinlife.top/2022/linux/MIT6-s081-lab4Trap/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/DiskANN%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E5%BC%80%E5%A7%8B/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giciszlczyj20zk0m816d.jpg" title="DiskANN（一）：代码阅读开始"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 数据库</span><h3>DiskANN（一）：代码阅读开始</h3></a></div><div class="item right"><a href="/2022/linux/MIT6-s081-PageFault/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giciuja1j1j20zk0m8kjl.jpg" title="MIT6.s081: lab5 PageFault"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> linux</span><h3>MIT6.s081: lab5 PageFault</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#risc-v-assembly"><span class="toc-number">1.</span> <span class="toc-text">RISC-V assembly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gdb%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4"><span class="toc-number">2.</span> <span class="toc-text">gdb 常用指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E8%B0%83%E8%AF%95"><span class="toc-number">2.1.</span> <span class="toc-text">开启调试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gdb%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.</span> <span class="toc-text">gdb 命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#qemu%E5%91%BD%E4%BB%A4"><span class="toc-number">2.3.</span> <span class="toc-text">qemu 命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#trap"><span class="toc-number">3.</span> <span class="toc-text">Trap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#trap%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">Trap 代码执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trap%E8%BF%9B%E5%85%A5"><span class="toc-number">3.2.</span> <span class="toc-text">trap 进入</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ecall%E5%81%9A%E7%9A%84%E4%BA%8B%E6%83%85"><span class="toc-number">3.2.1.</span> <span class="toc-text">ecall 做的事情</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E5%AF%84%E5%AD%98%E5%99%A8%E7%8A%B6%E6%80%81"><span class="toc-number">3.2.2.</span> <span class="toc-text">保存寄存器状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%A4%84%E7%90%86%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE"><span class="toc-number">3.2.3.</span> <span class="toc-text">加载处理内核数据</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">3.3.</span> <span class="toc-text">处理系统调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trap%E8%BF%94%E5%9B%9E"><span class="toc-number">3.4.</span> <span class="toc-text">trap 返回</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">4.</span> <span class="toc-text">参考资料：</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2022/linux/inode%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="inode学习">inode学习</a></li><li><a href="/2022/linux/PIC%EF%BC%9A%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/" rel="bookmark" title="PIC：进程间通信">PIC：进程间通信</a></li><li><a href="/2022/linux/%E5%88%9B%E5%BB%BA%E5%AD%90%E8%BF%9B%E7%A8%8B/" rel="bookmark" title="创建子进程">创建子进程</a></li><li><a href="/2022/linux/MIT6-S081%EF%BC%9AIntroduction/" rel="bookmark" title="MIT6.S081：Introduction">MIT6.S081：Introduction</a></li><li><a href="/2022/linux/MIT6-s081%EF%BC%9Alab1/" rel="bookmark" title="MIT6.s081：lab1">MIT6.s081：lab1</a></li><li><a href="/2022/linux/C%E6%8C%87%E9%92%88/" rel="bookmark" title="C指针">C指针</a></li><li><a href="/2022/linux/MIT6-s081%EF%BC%9Alab2/" rel="bookmark" title="MIT6.s081：lab2">MIT6.s081：lab2</a></li><li><a href="/2022/linux/MIT6-s081-lab3/" rel="bookmark" title="MIT6.s081: lab3">MIT6.s081: lab3</a></li><li class="active"><a href="/2022/linux/MIT6-s081-lab4Trap/" rel="bookmark" title="MIT6.s081: lab4Trap">MIT6.s081: lab4Trap</a></li><li><a href="/2022/linux/MIT6-s081-PageFault/" rel="bookmark" title="MIT6.s081: lab5 PageFault">MIT6.s081: lab5 PageFault</a></li><li><a href="/2022/MIT6-s081-lab5-COW/" rel="bookmark" title="MIT6.s081: lab5 COW">MIT6.s081: lab5 COW</a></li><li><a href="/2022/linux/MIT6-s081-%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="bookmark" title="MIT6.s081:多线程">MIT6.s081:多线程</a></li><li><a href="/2022/MIT6-s081-lab7thread/" rel="bookmark" title="MIT6.s081: lab7thread">MIT6.s081: lab7thread</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Kalice" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Kalice</p><div class="description" itemprop="description">Life is not about lifestyle, it means Lithium and Ferrum.</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">111</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">20</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">42</span> <span class="name">标签</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/DiskANN%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E5%BC%80%E5%A7%8B/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/linux/MIT6-s081-PageFault/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/ss/" title="分类于 琐事">琐事</a></div><span><a href="/2021/ss/VScode-%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95%E5%85%8D%E5%AF%86%E7%A0%81/" title="VScode 远程登录免密码">VScode 远程登录免密码</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Go/" title="分类于 Go">Go</a></div><span><a href="/2022/ss/git-%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/" title="git 常用指令">git 常用指令</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ai/" title="分类于 AI">AI</a></div><span><a href="/2021/ai/PageRank/" title="PageRank算法">PageRank算法</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" title="分类于 数据库">数据库</a></div><span><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/DiskANN%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E5%BC%80%E5%A7%8B/" title="DiskANN（一）：代码阅读开始">DiskANN（一）：代码阅读开始</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" title="分类于 分布式">分布式</a></div><span><a href="/2022/%E5%88%86%E5%B8%83%E5%BC%8F/MIT6-824%EF%BC%9AFrangipani-A-Scalable-Distributed-File-System/" title="MIT6.824：Frangipani: A Scalable Distributed File System">MIT6.824：Frangipani: A Scalable Distributed File System</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux/" title="分类于 linux">linux</a></div><span><a href="/2022/linux/PIC%EF%BC%9A%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/" title="PIC：进程间通信">PIC：进程间通信</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/python/" title="分类于 Python">Python</a></div><span><a href="/2021/python/pymongo%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2%EF%BC%88%E5%B5%8C%E5%A5%97%E3%80%81%E8%8C%83%E5%9B%B4%E3%80%81aggregate%EF%BC%89/" title="MTTU代码实现思路">MTTU代码实现思路</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" title="分类于 分布式">分布式</a></div><span><a href="/2022/%E5%88%86%E5%B8%83%E5%BC%8F/MIT6-824-Aurora/" title="MIT6.824: Amazon Aurora: Design Considerations for High Throughput Cloud-Native Relational Databases">MIT6.824: Amazon Aurora: Design Considerations for High Throughput Cloud-Native Relational Databases</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux/" title="分类于 linux">linux</a></div><span><a href="/2022/MIT6-s081-lab7thread/" title="MIT6.s081: lab7thread">MIT6.s081: lab7thread</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" title="分类于 数据库">数据库</a></div><span><a href="/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%EF%BC%9AA-Comprehensive-Survey-and-Experimental-Comparison-of-Graph-Based-Approximate-Nearest-Neighbor-Search/" title="论文阅读：A Comprehensive Survey and Experimental Comparison of Graph-Based Approximate Nearest Neighbor Search">论文阅读：A Comprehensive Survey and Experimental Comparison of Graph-Based Approximate Nearest Neighbor Search</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Kalice @ Songlin</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">224k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">3:24</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/linux/MIT6-s081-lab4Trap/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,copy_tex:!0,katex:!0,mermaid:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->